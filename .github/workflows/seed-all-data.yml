name: Seed All Data

on:
  # Run weekly on Sundays at midnight UTC
  schedule:
    - cron: '0 0 * * 0'

  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      run_housing:
        description: 'Run housing seed script'
        required: false
        default: true
        type: boolean
      run_capital:
        description: 'Run capital budget seed script'
        required: false
        default: true
        type: boolean
      run_financial:
        description: 'Run financial seed script'
        required: false
        default: true
        type: boolean

# Prevent concurrent runs
concurrency:
  group: seed-all-data
  cancel-in-progress: false

jobs:
  seed-data:
    name: Seed NYC Open Data
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NODE_ENV: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Push schema changes to database
        run: bunx drizzle-kit push --force

      - name: Run seed scripts with retry logic
        id: seed
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              # Manual trigger - run individual scripts based on inputs
              FAILED_SCRIPTS=()

              if [ "${{ inputs.run_housing }}" = "true" ]; then
                echo "â–¶ï¸  Running housing seed script..."
                if ! bun run seed:housing; then
                  FAILED_SCRIPTS+=("seed:housing")
                fi
              fi

              if [ "${{ inputs.run_capital }}" = "true" ]; then
                echo "â–¶ï¸  Running capital budget seed script..."
                if ! bun run seed:capital; then
                  FAILED_SCRIPTS+=("seed:capital")
                fi
              fi

              if [ "${{ inputs.run_financial }}" = "true" ]; then
                echo "â–¶ï¸  Running financial seed script..."
                if ! bun run seed:financial; then
                  FAILED_SCRIPTS+=("seed:financial")
                fi
              fi

              if [ ${#FAILED_SCRIPTS[@]} -ne 0 ]; then
                echo "âŒ Failed scripts: ${FAILED_SCRIPTS[*]}"
                exit 1
              fi
            else
              # Scheduled run - run all scripts
              bun run seed:all
            fi
          on_retry_command: |
            echo "âš ï¸  Retry attempt ${{ steps.seed.outputs.attempts }} of 3"
            echo "Waiting before retry..."

      - name: Generate seed summary
        if: success()
        run: |
          echo "## âœ… Data Seeding Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scripts Executed:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            [ "${{ inputs.run_housing }}" = "true" ] && echo "- âœ… Housing data seeded" >> $GITHUB_STEP_SUMMARY
            [ "${{ inputs.run_capital }}" = "true" ] && echo "- âœ… Capital budget data seeded" >> $GITHUB_STEP_SUMMARY
            [ "${{ inputs.run_financial }}" = "true" ] && echo "- âœ… Financial data seeded (sankeys, sunbursts)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… Housing data seeded" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Capital budget data seeded" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Financial data seeded (sankeys, sunbursts)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

      - name: Send email notification on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âŒ NYC Data Seeding Failed - ${{ github.repository }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.SMTP_FROM_EMAIL }}
          body: |
            Data Seeding Workflow Failed

            All retry attempts (3) have been exhausted.

            ğŸ“… Timestamp: ${{ github.event.head_commit.timestamp }}
            ğŸ”„ Trigger: ${{ github.event_name }}
            ğŸ“ Repository: ${{ github.repository }}
            ğŸŒ³ Branch: ${{ github.ref }}

            ğŸ”— View Workflow Logs:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            âš ï¸ Action Required:
            Please check the workflow logs for detailed error messages and investigate the cause of the failure.

            ---
            NYC Open Data Seeding Workflow

      - name: Upload logs as artifact on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: seed-failure-logs-${{ github.run_id }}
          path: |
            *.log
            .bun-debug.log*
          retention-days: 30
          if-no-files-found: ignore
